name: Testing

on:
  pull_request:
    types: ['opened', 'reopened', 'synchronize']

  workflow_dispatch:

jobs:
  test_game:
    runs-on: ubuntu-latest

    env:
      STOCKFISH_VERSION: 14.1
      PYTHON_VERSION: 3.10.2

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache external libraries
        id: cache-libraries
        uses: actions/cache@v2
        with:
          path: lib/
          key: ${{ runner.os }}-lib

      - name: Fetch required libraries if no cache was found
        if: steps.cache-libraries.outputs.cache-hit != 'true'
        run: ./scripts/setup.sh

      - name: Install dependencies and convert notebooks
        run: |
          pip install notebook -r src/requirements.txt
          jupyter nbconvert --to python \
            --output-dir="python" \
            --TemplateExporter.extra_template_basedirs="scripts" \
            --template nbconverter_template \
            src/*.ipynb

      - name: Run a sample test game
        working-directory: python
        shell: python
        run: |
          print("Running tests")
          import random
          from Main import *
          players = []
          players.append(Exercise01AI(player_name="Test"))
          players.append(Exercise02AI(player_name="Test"))
          players.append(Exercise03AI(player_name="Test"))
          players.append(Exercise04AI(player_name="Test"))
          players.append(Exercise05AI(player_name="Test"))
          players.append(Exercise06AI(player_name="Test"))
          players.append(Exercise07AI(player_name="Test"))
          players.append(StockfishPlayer(player_name="Test"))
          HumanPlayer(player_name="Test")
          player1 = random.choice(players)
          player2 = random.choice(players)
          run_games(player1, player2, repetitions=3, seed=13)

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v2
        with:
          name: results
          path: games/
